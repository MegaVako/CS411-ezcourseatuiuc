<!doctype html>
<html lang="en">
<head>
  <title>EasyCourse@UIUC</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.getElementsByTagName("html")[0].className += " js";</script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>


  {% load compress static %}
  {% compress css %}
  <link type="text/x-scss" href="https://easycourseatuiuc.web.illinois.edu/main_page{% static 'schedule/assets/css/style.scss' %}" rel="stylesheet" media="screen">
  {% endcompress %}

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

  <!-- Navbar -->
  <div class="position-relative">
  <div class="w3-navibar">
  <div class="w3-bar w3-red w3-card w3-left-align w3-large">
  <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-red" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
  <a href="http://easycourseatuiuc.web.illinois.edu/" class="w3-bar-item w3-button w3-padding-large w3-hover-white">Home</a>
  <a href="mailto:yans3@illinois.edu" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Contact Us</a>
  <a href="http://illinois.edu/"><img src="https://campusrec.illinois.edu/wp-content/uploads/2017/08/block-I-icon-512x512-300x300.png" style="width:42px;height:50px;"></a>
    <button class="w3-button w3-teal w3-xlarge w3-right" onclick="openRightMenu()" style="font-size:24px">Edit Cart<i class="fa fa-shopping-cart"></i></button>
  </div>
  </div>

  <!-- Navbar on small screens -->
  <div id="navDemo" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
  <a href="mailto:yans3@illinois.edu" class="w3-bar-item w3-button w3-padding-large">Contact Us</a>
 </div>
 <body>
    <div  class="w3-sidebar w3-bar-block w3-card w3-animate-left w3-blue w3-large" style="display:none;left:0;" id="leftMenu">
      <button onclick="closeRightMenu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
      <form action="https://easycourseatuiuc.web.illinois.edu/main_page/" >
        <p class="w3-padding-16"><input formtarget="_blank" class="w3-button w3-black" type="submit" value="search more"><i class="fa fa-search"></i></input></p>
      </form>
      <div class="w3-container"id="courseCheckBoxContainer">
      <!-- Insert cart in here DEBUG -->
      </div>
      <!-- <p id="clearBtn" class="w3-padding-16"><button class="w3-button w3-black" onclick="" type="button">Remove Item</button></p> NOT USED-->
    </div>
<div class="w3-container">
  <p name="DEBUG">{{ context.cart_info }}</p>
  <div class="cd-schedule cd-schedule--loading margin-top-lg margin-bottom-lg js-cd-schedule">
    <div class="cd-schedule__timeline">
      <ul>
        <li><span>08:00</span></li>
        <li><span>08:30</span></li>
        <li><span>09:00</span></li>
        <li><span>09:30</span></li>
        <li><span>10:00</span></li>
        <li><span>10:30</span></li>
        <li><span>11:00</span></li>
        <li><span>11:30</span></li>
        <li><span>12:00</span></li>
        <li><span>12:30</span></li>
        <li><span>13:00</span></li>
        <li><span>13:30</span></li>
        <li><span>14:00</span></li>
        <li><span>14:30</span></li>
        <li><span>15:00</span></li>
        <li><span>15:30</span></li>
        <li><span>16:00</span></li>
        <li><span>16:30</span></li>
        <li><span>17:00</span></li>
        <li><span>17:30</span></li>
        <li><span>18:00</span></li>
        <li><span>18:30</span></li>
        <li><span>19:00</span></li>
        <li><span>19:30</span></li>
        <li><span>20:00</span></li>
        <li><span>20:30</span></li>
        <li><span>21:00</span></li>
        <li><span>21:30</span></li>
        <li><span>22:00</span></li>
      </ul>
    </div> <!-- .cd-schedule__timeline -->

    <div class="cd-schedule__events">
      <ul>
        <li class="cd-schedule__group">
          <div class="cd-schedule__top-info"><span>Monday</span></div>
          <ul>
            {% for c in context.cart_info.Monday %}
            <li class="cd-schedule__event">
            <a data-start="{{ c.time_start }}" data-end="{{ c.time_end }}"  data-content="event-rowing-workout" data-event="event-{{ c.color }}" href="#0">
                <em class="cd-schedule__name">{{ c.department }}{{ c.course_num }} {{ c.lecture_type }}</em>
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>

        <li class="cd-schedule__group">
          <div class="cd-schedule__top-info"><span>Tuesday</span></div>

          <ul>

            {% for c in cart_info.Tuesday %}
            <li class="cd-schedule__event">
            <a data-start="{{ c.time_start }}" data-end="{{ c.time_end }}"  data-content="event-rowing-workout" data-event="event-{{ c.color }}" href="#0">
                <em class="cd-schedule__name">{{ c.department }}{{ c.course_num }} {{ c.lecture_type }}</em>
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>

        <li class="cd-schedule__group">
          <div class="cd-schedule__top-info"><span>Wednesday</span></div>

          <ul>
            {% for c in context.cart_info.Wednesday %}
            <li class="cd-schedule__event">
            <a data-start="{{ c.time_start }}" data-end="{{ c.time_end }}"  data-content="event-rowing-workout" data-event="event-{{ c.color }}" href="#0">
                <em class="cd-schedule__name">{{ c.department }}{{ c.course_num }} {{ c.lecture_type }}</em>
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>

        <li class="cd-schedule__group">
          <div class="cd-schedule__top-info"><span>Thursday</span></div>

          <ul>
            {% for c in context.cart_info.Thursday %}
            <li class="cd-schedule__event">
            <a data-start="{{ c.time_start }}" data-end="{{ c.time_end }}"  data-content="event-rowing-workout" data-event="event-{{ c.color }}" href="#0">
                <em class="cd-schedule__name">{{ c.department }}{{ c.course_num }} {{ c.lecture_type }}</em>
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>

        <li class="cd-schedule__group">
          <div class="cd-schedule__top-info"><span>Friday</span></div>

          <ul>
            {% for c in context.cart_info.Friday %}
            <li class="cd-schedule__event">
            <a data-start="{{ c.time_start }}" data-end="{{ c.time_end }}"  data-content="event-rowing-workout" data-event="event-{{ c.color }}" href="#0">
                <em class="cd-schedule__name">{{ c.department }}{{ c.course_num }} {{ c.lecture_type }}</em>
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>
      </ul>
    </div>

    <div class="cd-schedule-modal">
      <header class="cd-schedule-modal__header">
        <div class="cd-schedule-modal__content">
          <span class="cd-schedule-modal__date"></span>
          <h3 class="cd-schedule-modal__name"></h3>
        </div>

        <div class="cd-schedule-modal__header-bg"></div>
      </header>

      <div class="cd-schedule-modal__body">
        <div class="cd-schedule-modal__event-info"></div>
        <div class="cd-schedule-modal__body-bg"></div>
      </div>

      <a href="#0" class="cd-schedule-modal__close text-replace">Close</a>
    </div>

    <div class="cd-schedule__cover-layer"></div>
  </div> <!-- .cd-schedule -->
</div>
  <script>
    function dropDownFunc(clicked_id) {
        var x = document.getElementById(clicked_id);
        if (x.className.indexOf("w3-show") == -1) {
          x.className += " w3-show";
        } else { 
          x.className = x.className.replace(" w3-show", "");
        }
        console.log("clicked " + clicked_id);
    }
    function openRightMenu() {
      document.getElementById("leftMenu").style.display = "block";
    }

    function closeRightMenu() {
      document.getElementById("leftMenu").style.display = "none";
    }
    // =========================================================================
    // 168 = 14hr * 12; 12 5-min-block per hr
    var time_table = createArray(5, 180); // 180 = overkill
    var day_arr = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    var day_arr_short = ["M", "T", "W", "T", "F"];
    var schedule_data = '{{ context|safe }}';
    var course_group = '{{ course_group|safe }}';
    var time_map = new Map();
    function getScheduleData() {
      schedule_data = JSON.parse(schedule_data);
      course_group = JSON.parse(course_group);
      if (schedule_data.ok) {
        console.log(schedule_data); //DEBUG
        console.log(course_group); //DEBUG
        alert("load schedule data succeed \n"); 
        initScheduleBar();
      } else {
        alert("load schedule data failed \n" + schedule_data.msg);
      }
    }
    function createArray(length) {
      var arr = new Array(length || 0),
      i = length;

      if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while(i--) arr[length-1 - i] = createArray.apply(this, args);
      }
      return arr;
    }
    // function from https://stackoverflow.com/questions/12274748/setting-multiple-attributes-for-an-element-at-once-with-javascript
    Element.prototype.setAttributes = function (attrs) {
      for (var idx in attrs) {
        if ((idx === 'styles' || idx === 'style') && typeof attrs[idx] === 'object') {
          for (var prop in attrs[idx]){this.style[prop] = attrs[idx][prop];}
        } else if (idx === 'html') {
          this.innerHTML = attrs[idx];
        } else {
          this.setAttribute(idx, attrs[idx]);
        }
      }
    };
    function onClickHandler(element) {
      console.log("handler " + element.id);
      // always assume map has the key (or crash)
      // 0 -- day, 1 -- start time block, 2 -- diff block count
      // see init for detail
      var self_id = parseInt(element.id);
      var curr_cordinate = time_map.get(self_id);
      var curr_state = time_map.get(self_id + 100000); // boot lag way of getting status
      var blocked_course = {};
      var curr_block = "";
      for (let x in curr_cordinate) {
        for (let i = 0; i <= curr_cordinate[x][2]; i++) {
          curr_block = time_table[curr_cordinate[x][0]][i + curr_cordinate[x][1]];
          if (typeof curr_block != "undeinfed") {
            console.log("HI2")
            for (let y in curr_block) {
              if (curr_block[y] != self_id) {
                // if state = false, means about to become true, thus others' would be false
                blocked_course[curr_block[y]] = curr_state; 
              }
            } 
          }
        } 
      }
      time_map.set(self_id + 100000, !curr_state);
      for (let x in blocked_course) {
        changeCheckBox(x, blocked_course[x]);
      }
    };
    function changeSchedule(id, set_to) {

    }
    // set_to true for enable, false for disable
    function changeCheckBox(id, set_to) {
      console.log(set_to.toString() + " " + id.toString() + "_checkbox");
      document.getElementById(id.toString() + "_checkbox").disabled = !set_to;
    };
    function initScheduleBar() {
      for (var key in course_group) {
        if (course_group.hasOwnProperty(key)) {
          console.log(key) // department + course_num
          var each_course = course_group[key].parsed_result;
          var button_base = document.createElement("div");
          var button_self = document.createElement("button");
          var section_drop = document.createElement("div");

          button_base.setAttribute("class", "w3-dropdown-click")
          button_self.setAttribute("onClick", "dropDownFunc('" + key + "')")
          button_self.setAttribute("class", "w3-button w3-black")
          button_self.textContent = key
          button_base.appendChild(button_self);
          section_drop.setAttributes({
            "class": "w3-dropdown-content w3-bar-block w3-border",
            "id": key
          })

          for (var section in each_course) {
            // ================================================== html related
            var section_base = document.createElement("p");
            var section_checkBox = document.createElement("input");
            var curr_crn = each_course[section]["crn"]; 
            section_checkBox.setAttributes({
              "class": "w3-check",
              "type": "checkbox",
              "onclick": "onClickHandler(this)",
              "id": curr_crn + "_checkbox"
            })
            var section_info = document.createElement("label")
            section_info.setAttribute("class", "w3-small")
            section_info.setAttribute("for", curr_crn + "_checkbox")
            section_info.textContent = (each_course[section]["lecture_type"] + " " + each_course[section]["time_start"] + "-" + each_course[section]["time_end"] + " ");

            // ================================================== time_table related
            var curr_time = each_course[section]["time_start"];
            var curr_day = each_course[section]["day_of_week"];
            if (curr_time != -1) { // -1 for not a time schedule, explained in parsing
              curr_time = curr_time.split(":");
              curr_day = parseInt(curr_day)
              for (var i = 0; i < 5; i++) {
                if ((curr_day >> i) & 1) {
                  section_info.textContent += day_arr_short[i];
                  // start at 8, each hr is 12 * 5-min block
                  var time_start_block = ((parseInt(curr_time[0]) - 8) * 12) - 1; // hour, 0 based
                  time_start_block += (parseInt(curr_time[1]) / 5); // min

                  // end at time diff, retract 1 5-min block
                  var count_diff = parseInt(each_course[section]["time_diff"]) - 1
                  var time_end_block = count_diff + time_start_block

                  if (typeof time_table[i][time_start_block] != "undefined") {
                    time_table[i][time_start_block].push(curr_crn)
                  } else {
                    time_table[i][time_start_block] = [curr_crn]
                  }
                  if (typeof time_table[i][time_end_block] != "undefined") {
                    time_table[i][time_end_block].push(curr_crn)
                  } else {
                    time_table[i][time_end_block] = [curr_crn]
                  }
                  if (time_map.has(curr_crn)) {
                    time_map.get(curr_crn).push([i, time_start_block, count_diff])
                  } else {
                    time_map.set(curr_crn, [[i, time_start_block, count_diff]])
                    time_map.set(curr_crn + 100000, false) // boot lag way of keeping status
                  }
                }
              }
            }
            section_info.appendChild(section_checkBox); // <-- input under label
            section_base.appendChild(section_info); // <-- label under p
            section_drop.append(section_base); // p under div drop
          }
          button_base.appendChild(section_drop);
          document.getElementById('courseCheckBoxContainer').appendChild(button_base);
        }
      }
      debug_timeTable();
    };
    function debug_timeTable() {
      for (var i = 0; i < 5; i++) {
        for (var j = 0; j < 168; j++) {
          if (typeof time_table[i][j] != "undefined") {
            console.log(j);
            console.log(time_table[i][j]);   
          }
        }
      }
    };
    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
    }
    function setCookie(cname, cvalue, exdays) {
      var d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      var expires = "expires="+d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      if (cvalue.localeCompare("") == 0) {
        alert("Your cart has been cleared")
        document.getElementById("DEBUG").innerHTML = document.cookie + " " + "curr";
      }
    }
    window.onload = getScheduleData; // !!! CAREFUL, call getScheduleData as soon as the site load
  </script>
  {% load static %}
  <script src="/main_page/{% static '/schedule/assets/js/util.js' %}"></script> <!-- util functions included in the CodyHouse framework -->
  <script src="/main_page/{% static '/schedule/assets/js/main.js' %}"></script> <!-- util functions included in the CodyHouse framework -->
</body>
</html>
